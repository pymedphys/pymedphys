name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_call:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      mosaiq: ${{ steps.filter.outputs.mosaiq }}
    steps:
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            mosaiq:
              - 'lib/pymedphys/**/*mosaiq*'
              - 'lib/pymedphys/**/*database*'

  pre-commit:
    uses: ./.github/workflows/pre-commit.yml
    secrets: inherit

  tests:
    needs: [pre-commit]
    if: success() || failure()
    uses: ./.github/workflows/tests.yml
    with:
      mode: ${{ github.event_name == 'pull_request' && 'standard' || 'full' }}
      include-cypress: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    secrets: inherit
    permissions:
      contents: read  # Tests only need read access

  mosaiq-db-tests:
    needs: [pre-commit, changes]
    if: |
      (success() || failure()) && (
        github.event_name == 'push' ||
        contains(github.event.pull_request.labels.*.name, 'database') ||
        needs.changes.outputs.mosaiq == 'true'
      )
    uses: ./.github/workflows/mosaiq-db-tests.yml
    secrets: inherit
    permissions:
      contents: read  # DB tests only need read access

  docs-check:
    needs: [tests]
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/docs.yml
    with:
      publish: false
    secrets: inherit
    permissions:
      contents: read

  docs:
    needs: [tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/docs.yml
    secrets: inherit
    permissions:
      contents: write
      pages: write
      id-token: write

  summary:
    needs: [pre-commit, tests, mosaiq-db-tests, docs]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Generate Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## CI Results ðŸ“Š

          | Job | Status |
          |-----|--------|
          | Pre-commit | ${{ needs.pre-commit.result }} |
          | Tests | ${{ needs.tests.result }} |
          | Database Tests | ${{ needs.mosaiq-db-tests.result || 'skipped' }} |
          | Documentation | ${{ needs.docs.result || 'skipped' }} |

          **Workflow:** ${{ github.workflow }}
          **Triggered by:** ${{ github.actor }}
          **Event:** ${{ github.event_name }}
          EOF
