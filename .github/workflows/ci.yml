name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_call:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  pre-commit:
    uses: ./.github/workflows/pre-commit.yml
    secrets: inherit

  tests:
    needs: [pre-commit]
    if: success() || failure()  # Run tests even if pre-commit fails
    uses: ./.github/workflows/tests.yml
    with:
      matrix: ${{ github.event_name == 'pull_request' && 'standard' || 'full' }}
    secrets: inherit

  mosaiq-db-tests:  # ADD THIS
    needs: [pre-commit]
    if: |
      (success() || failure()) &&
      (github.event_name == 'push' ||
       contains(github.event.pull_request.labels.*.name, 'database'))
    uses: ./.github/workflows/mosaiq-db-tests.yml
    secrets: inherit

  docs:
    needs: [tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/docs.yml
    secrets: inherit

  summary:
    needs: [pre-commit, tests, mosaiq-db-tests, docs]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## CI Results ðŸ“Š

          | Job | Status |
          |-----|--------|
          | Pre-commit | ${{ needs.pre-commit.result }} |
          | Tests | ${{ needs.tests.result }} |
          | Database Tests | ${{ needs.mosaiq-db-tests.result || 'skipped' }} |
          | Documentation | ${{ needs.docs.result || 'skipped' }} |

          **Workflow:** ${{ github.workflow }}
          **Triggered by:** ${{ github.actor }}
          **Event:** ${{ github.event_name }}
          EOF
