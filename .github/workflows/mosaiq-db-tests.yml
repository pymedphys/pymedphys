name: Mosaiq DB tests

on:
  workflow_call:
    secrets:
      MOSAIQ_DB_URL:
        required: false
      MOSAIQ_DB_USER:
        required: false
      MOSAIQ_DB_PASS:
        required: false
  workflow_dispatch:

permissions:
  contents: read

jobs:
  mosaiq:
    runs-on: ubuntu-24.04
    env:
      HAS_DB: ${{ secrets.MOSAIQ_DB_URL != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-project
        with:
          python-version: "3.12"
          cache-key-suffix: mosaiq
      - name: Install DB extras
        shell: bash
        run: uv pip install -e ".[dev,mosaiq]" --system
      - name: Run DB tests if secrets present
        if: env.HAS_DB == 'true'
        shell: bash
        env:
          MOSAIQ_DB_URL:  ${{ secrets.MOSAIQ_DB_URL }}
          MOSAIQ_DB_USER: ${{ secrets.MOSAIQ_DB_USER }}
          MOSAIQ_DB_PASS: ${{ secrets.MOSAIQ_DB_PASS }}
        run: uv run pytest -q -m "mosaiq"
      - name: Skip (no secrets)
        if: env.HAS_DB != 'true'
        shell: bash
        run: echo "No DB secrets provided; skipping."
